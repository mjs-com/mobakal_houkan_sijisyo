# デバッグ手順 - 開発段階での動作確認方法

## 開発段階での動作確認方法

### パッケージ化について

**開発段階ではパッケージ化は不要です。** フォルダを直接読み込む方法で問題ありません。パッケージ化は、Chrome Web Storeに公開する場合や、配布用の`.crx`ファイルを作成する場合のみ必要です。

## ステップ1: 拡張機能の読み込み確認

1. Chromeで `chrome://extensions/` を開く
2. 「デベロッパーモード」がONになっていることを確認
3. 拡張機能一覧に「モバカル訪問看護指示書 日付自動入力」が表示されていることを確認
4. 拡張機能が「有効」になっていることを確認（スイッチがON）

## ステップ2: バックグラウンドスクリプトのデバッグ

### サービスワーカーの状態を確認

1. `chrome://extensions/` で拡張機能の詳細を確認
2. 「ビューを検証」または「Service Worker」の項目を確認
   - **「Service Worker (無効)」と表示されている場合**: サービスワーカーがエラーで停止しています
   - **「Service Worker」リンクが表示されている場合**: リンクをクリックして開発者ツールを開く

### サービスワーカーが無効な場合の対処法

**「Service Worker (無効)」と表示されている場合:**

1. **拡張機能を再読み込み**
   - `chrome://extensions/` で拡張機能の「再読み込み」ボタン（🔄）をクリック
   - これでサービスワーカーが再起動されます

2. **エラーメッセージを確認**
   - 拡張機能の詳細ページにエラーメッセージが表示されることがあります
   - 「エラー」セクションを確認してください

3. **手動でサービスワーカーのコンソールを開く**
   - 拡張機能の詳細ページで「エラーを収集する」がONになっていることを確認
   - ブラウザを再起動してから再度確認

4. **background.jsの構文エラーを確認**
   - `background.js` ファイルに構文エラーがないか確認
   - ファイルが正しく保存されているか確認

### サービスワーカーが有効な場合

1. 「Service Worker」リンクをクリック
2. 開発者ツールが開きます（これがバックグラウンドスクリプトのコンソール）
3. このコンソールに `[Background]` で始まるログが表示されます

### 確認すべきこと

- アイコンをクリックしたときに `[Background] アイコンがクリックされました。` というログが表示されるか
- エラーメッセージが表示されていないか
- サービスワーカーが正常に起動しているか（コンソールにエラーがないか）

## ステップ3: コンテンツスクリプトのデバッグ

1. **モバカルのページを開く**（訪問看護指示書作成ページ）
2. **F12キー**を押して開発者ツールを開く
3. **「Console」タブ**を選択
4. ページをリロード（F5キー）

### 確認すべきこと

- ページを読み込んだときに `[Content] content.js が読み込まれました。` というログが表示されるか
- アイコンをクリックしたときに `[Content] メッセージを受信:` というログが表示されるか
- 入力欄が見つかったかどうかのログが表示されるか

## ステップ4: 動作確認の手順

### 完全なデバッグ手順

1. **バックグラウンドスクリプトのコンソールを開く**
   - `chrome://extensions/` → 拡張機能の「サービスワーカー」をクリック

2. **モバカルのページを開く**
   - 訪問看護指示書作成ページを開く

3. **ページの開発者ツールを開く**
   - F12キーを押す
   - 「Console」タブを選択

4. **ページをリロード**
   - F5キーを押す
   - コンソールに `[Content] content.js が読み込まれました。` が表示されることを確認

5. **拡張機能のアイコンをクリック**

6. **両方のコンソールを確認**
   - **バックグラウンドスクリプトのコンソール**:
     - `[Background] アイコンがクリックされました。` が表示されるか
     - エラーメッセージが表示されていないか
   - **ページのコンソール**:
     - `[Content] メッセージを受信:` が表示されるか
     - `[Content] 計算された日付:` が表示されるか
     - `[Content] 入力欄の検索結果:` が表示されるか
     - 各入力欄が見つかったかどうかが表示されるか

## よくある問題と解決方法

### 問題0: サービスワーカーが「無効」と表示される

**原因**: `background.js` にエラーがある、またはサービスワーカーが正常に起動できていない

**解決方法**:
1. **拡張機能を再読み込み**
   - `chrome://extensions/` で「再読み込み」ボタン（🔄）をクリック
   - サービスワーカーが再起動されます

2. **エラーメッセージを確認**
   - 拡張機能の詳細ページにエラーメッセージが表示されることがあります
   - 「エラー」セクションを確認

3. **background.jsの構文を確認**
   - `background.js` ファイルに構文エラーがないか確認
   - ファイルが正しく保存されているか確認
   - コンソールでエラーを確認（F12 → Consoleタブ）

4. **ブラウザを再起動**
   - Chromeを完全に終了してから再起動

5. **拡張機能を一度削除して再読み込み**
   - `chrome://extensions/` で拡張機能を削除
   - 「パッケージ化されていない拡張機能を読み込む」で再度読み込み

### 問題1: バックグラウンドスクリプトのコンソールに何も表示されない

**原因**: アイコンクリックイベントが発火していない、またはサービスワーカーが無効

**解決方法**:
- まず「問題0」の解決方法を試す
- 拡張機能が有効になっているか確認
- 拡張機能を再読み込み（`chrome://extensions/` で「再読み込み」ボタンをクリック）
- ブラウザを再起動

### 問題2: バックグラウンドスクリプトでエラーが表示される

**エラー例**: `Could not establish connection. Receiving end does not exist.`

**原因**: content.jsが読み込まれていない、またはメッセージリスナーが設定されていない

**解決方法**:
- ページのコンソールで `[Content] content.js が読み込まれました。` が表示されるか確認
- ページをリロードしてから再度アイコンをクリック
- `manifest.json` の `content_scripts` 設定を確認

### 問題3: ページのコンソールに何も表示されない

**原因**: content.jsが読み込まれていない

**解決方法**:
- ページをリロード（F5キー）
- `chrome://extensions/` で拡張機能を再読み込み
- `manifest.json` の `content_scripts.matches` が正しいか確認（現在は `<all_urls>` なので問題ないはず）

### 問題4: メッセージは受信されるが、入力欄が見つからない

**原因**: ページのHTML構造が異なる、またはページが完全に読み込まれていない

**解決方法**:
- ページのコンソールで `[Content] 入力欄の検索結果:` を確認
- どの入力欄が見つからないか確認
- ページのHTMLを確認（F12 → Elementsタブ）
- 実際の `name` 属性を確認:
  ```javascript
  document.querySelector('input[name="disp_date"]')
  document.querySelector('input[name="char1_kinyubi"]')
  document.querySelector('input[name="char1_houkanstart"]')
  document.querySelector('input[name="char1_houkanend"]')
  ```

### 問題5: 入力欄は見つかるが、値が設定されない

**原因**: イベントが正しく発火していない、またはページのJavaScriptが値を上書きしている

**解決方法**:
- ページのコンソールで `[Content] disp_date に ... を設定しました。` というログが表示されるか確認
- 手動で値を設定してみる:
  ```javascript
  const input = document.querySelector('input[name="disp_date"]');
  input.value = '2025-12-22';
  input.dispatchEvent(new Event('input', { bubbles: true }));
  input.dispatchEvent(new Event('change', { bubbles: true }));
  ```

## テスト用の簡易チェックリスト

- [ ] 拡張機能が `chrome://extensions/` に表示されている
- [ ] 拡張機能が「有効」になっている
- [ ] バックグラウンドスクリプトのコンソールが開ける
- [ ] ページを開いてF12で開発者ツールが開ける
- [ ] ページのコンソールに `[Content] content.js が読み込まれました。` が表示される
- [ ] アイコンをクリックすると、バックグラウンドスクリプトのコンソールにログが表示される
- [ ] アイコンをクリックすると、ページのコンソールにログが表示される
- [ ] 入力欄が見つかったというログが表示される
- [ ] 実際に値が入力される

## パッケージ化について（参考）

### 開発段階

- **パッケージ化は不要**
- フォルダを直接読み込む方法で開発・デバッグ可能
- コードを変更したら、`chrome://extensions/` で「再読み込み」ボタンをクリックするだけ

### パッケージ化が必要な場合

- Chrome Web Storeに公開する場合
- `.crx` ファイルとして配布する場合
- 本番環境にデプロイする場合

### パッケージ化の方法（参考）

1. `chrome://extensions/` を開く
2. 「パッケージ化」または「Pack extension」をクリック
3. 拡張機能のルートディレクトリを選択
4. `.crx` ファイルと `.pem` キーファイルが生成される

**注意**: パッケージ化しても動作は変わりません。開発段階では不要です。

